#!/bin/bash

set -u

OS="";
case "$OSTYPE" in
  solaris*) OS="SOLARIS" ;;
  darwin*)  OS="OSX" ;;
  linux*)   OS="LINUX" ;;
  bsd*)     OS="BSD" ;;
  msys*)    OS="WINDOWS" ;;
  *)        OS="UNKNOWN" ;;
esac

DOTFILES_DIR=$HOME/Src/dotfiles.git/

dotfiles() {
  git --git-dir=$DOTFILES_DIR --work-tree=$HOME "$@"
}

# pull dotfiles
if [[ ! -d $DOTFILES_DIR ]] ; then
  mkdir -p $DOTFILES_DIR
  git clone --bare  --recursive git@github.com/yld/dotfiles $DOTFILES_DIR
  dotfiles checkout
else
  if [[ "$(dotfiles status --porcelain | wc -l)" == "0" ]] ; then
    dotfiles pull --rebase
  else
    echo "You have some uncommitted changes in dotfiles files. Skipping update..."
  fi
fi

TOOLS_INSTALLED="yes"

check_tool() {
  local TOOL=$1
  if [[ ! -x $(command -v $TOOL) ]]; then
    TOOLS_INSTALLED="no"
    echo "You should install $TOOL before continuing..."
  fi
}


for TOOL in "wget tmux tree the_silver_searcher zsh pwgen shellcheck jq keychain neovim ctags"; do
  check_tool "$TOOL"
done

brew_check_and_install() {
  local TOOL=$1
  if [[ ! $(brew ls --versions $TOOL) ]]; then
    brew install $TOOL
  fi
}

case $OS in
  "OSX")
  [[ ! -L ~/Fonts  ]] && ln -sf ~/.fonts ~/Fonts;
  for TOOL in "gnu-sed wxmac"; do
    brew_check_and_install $TOOL
  done
  ;;
  *)
  echo "doing nothing...";
  ;;
esac

[[ "$TOOLS_INSTALLED" = "no" ]] && exit 1

# zsh plugin install + dynamic configurations
if [[ -x $(command -v zsh) ]] ; then
  ZPLUGD=~/.zplugd
  [[ ! -d $ZPLUGD ]] && git clone https://github.com/zplug/zplug $ZPLUGD
  # echo ". ~/.zplugd/init.zsh ; [[ ! zplug check --verbose ]] && zplug install" | zsh -s
  # for shell in 'zsh fish bashrc'
  if [[ -x $(command -v grc) ]]; then
    if [[ -r  /etc/grc.zsh ]] ; then
      ln -sf ~/.zsh/grc.zsh /etc/grc.conf
    else
      wget https://raw.githubusercontent.com/garabik/grc/master/grc.zsh -O ~/.zsh/grc.zsh --quiet
    fi
  fi
fi

# asdf
if [[ ! -d $HOME/.asdf ]] ; then
  git clone https://github.com/asdf-vm/asdf.git ~/.asdf --branch v0.4.3
fi

DEFAULT_NODE_ASDF_PKG_FILE="${HOME}/.default-npm-packages"
touch "$DEFAULT_NODE_ASDF_PKG_FILE"
for PKG in css-lint sass-lint stylelint prettier jsonlint ember-template-lint neovim prettier; do
  grep "^${PKG}$" $DEFAULT_NODE_ASDF_PKG_FILE > /dev/null || echo $PKG >> $DEFAULT_NODE_ASDF_PKG_FILE
done

DEFAULT_RUBY_ADSF_PKG_FILE="${HOME}/.default-gems"
touch "$DEFAULT_RUBY_ADSF_PKG_FILE"
for PKG in gem-ctags gem-browse awesome_print pry bundler rubocop haml_lint brakeman rubocop-rspec rails_best_practices sqlint erubi mdl neovim gist landscape; do
  grep "^${PKG}$" $DEFAULT_RUBY_ADSF_PKG_FILE > /dev/null || echo $PKG >> $DEFAULT_RUBY_ADSF_PKG_FILE
done

# Node.js release team's OpenPGP keys
bash ~/.asdf/plugins/nodejs/bin/import-release-team-keyring

asdf plugin-add erlang
asdf plugin-add elixir
asdf plugin-add ruby
asdf plugin-add nodejs
asdf plugin-add python
asdf plugin-add terraform
asdf plugin-add terragrunt

asdf plugin-update --all > /dev/null

# vim part (probably outdated)
if [[ -x $(command -v vim) ]] ; then
  BUNDLE_DIR=~/.vim/bundle
  VUNDLE_DIR=${BUNDLE_DIR}/vundle
  # mkdir -p $VUNDLE_DIR > /dev/null
  mkdir -p ~/.vim/{backup,swp} >> /dev/null
  if [[ ! -d $VUNDLE_DIR ]] ; then
    mkdir -p $BUNDLE_DIR && git clone https://github.com/gmarik/vundle.git $VUNDLE_DIR
    vim +PluginInstall +qall
  else
    # fix for https://github.com/VundleVim/Vundle.vim/issues/470
    pushd $VUNDLE_DIR >> /dev/null
    git pull
    popd > /dev/null
    vim +PluginUpdate +qall
    vim +PluginClean! +qall
  fi
fi

# nvim part
if [[ -x $(command -v nvim) ]] ; then
  PLUGGED_DIR=~/.local/share/nvim/plugged
  if [[ ! -d $PLUGGED_DIR ]] ; then
    curl -fLo ~/.local/share/nvim/site/autoload/plug.vim --create-dirs https://raw.githubusercontent.com/junegunn/vim-plug/master/plug.vim
    mkdir -p $PLUGGED_DIR
    nvim +PlugInstall! +qall
  else
    nvim +PlugUpdate! +qall
  fi
fi

# yarn
# NOTE: yarn is installed as a plugin for zsh but we enforce its installation here
[[ ! -x $(command -v yarn) ]] || (curl -o- -L https://yarnpkg.com/install.sh | bash)
# yarn global add sass-lint stylelint prettier jsonlint ember-template-lint --check-files --dev
